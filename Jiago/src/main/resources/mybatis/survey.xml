<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
   "-//mybatis.org//DTD Mapper 3.0//EN" 
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
<mapper namespace="com.itbank.repository.SurveyDAO">


   <select id="selectList" resultType="survey">
      select * from survey where to_date(substr(survey_date,10)) >= sysdate order by survey_idx
   </select>

   <select id="selectOneDetail" parameterType="int" resultType="survey">
      select * from survey where survey_idx = #{survey_idx}
   </select>
   
   <select id="selectSurveyQuestion" parameterType="int" resultType="surveyQuestion">
      select * from survey_question where question_idx > 1 and survey_idx = #{survey_idx} order by question_idx
   </select>
   
   <select id="selectSurveyExample" parameterType="int" resultType="surveyExample">
      select * from survey_example where question_idx > 1 and survey_idx = #{survey_idx} order by question_idx
   </select>
   
   <insert id="insertAnswer" parameterType="HashMap">
      insert into answer(question_idx, survey_idx, user_idx, answer_content) values (1, #{survey_idx}, #{user_idx}, #{answer_content})
   </insert>
   
   <select id="selectQuestionIdx" parameterType="HashMap" resultType="int">
      select question_idx from survey_question  where survey_idx = #{survey_idx} and question_idx > 1 order by question_idx
   </select>

   <update id="insertAnswerSubstr" parameterType="HashMap">
      <foreach collection="questionIdx" item="item" index="index" open="insert all" close="select * from dual" separator=" ">
      into answer (answer_idx, user_idx, answer_content, question_idx, survey_idx)
        values 
            (get_seq('answer_seq'),
             #{user_idx},
             (select REGEXP_SUBSTR(answer_content, '[^,]+', 1, ${index + 1}) from answer where question_idx = 1 and user_idx = #{user_idx}),
             #{item},
             #{survey_idx})
      </foreach>
   </update>

   <delete id="deleteAnswerResult" parameterType="HashMap">
      delete answer where survey_idx = #{survey_idx} and question_idx = 1 and user_idx = #{user_idx}
   </delete>
   
   <insert id="insertUserPoint" parameterType="HashMap">
   		insert into point(user_idx, survey_idx, point) values (#{user_idx}, #{survey_idx}, (select survey_point from survey where survey_idx = #{survey_idx}))
   </insert>

	<insert id="insertUserDonate" parameterType="userDonate">
		insert into user_donate (user_idx, survey_idx, total_donate) values (#{user_idx}, #{survey_idx}, #{total_donate})	
	</insert>
	
	<insert id="minusUserPoint" parameterType="userDonate">
		insert into point(user_idx, survey_idx, point) values (#{user_idx}, #{survey_idx}, -#{total_donate})
	</insert>

	<select id="selectUserPoint" parameterType="int" resultType="int">
		select sum(point) from point where user_idx = #{user_idx}
	</select>
	
	<select id="selectHomeSurvey" resultType="survey">
		select * from survey where to_date(substr(survey_date,10)) >= sysdate and rownum BETWEEN 1 AND 6 order by to_date(substr(survey_date,10))
	</select>
	
	<insert id="insertSurvey" parameterType="survey">
      insert into survey
          (company_idx, survey_title, survey_date, survey_point, survey_time, 
           survey_targetAge, survey_targetGender, survey_targetJob, survey_info) 
          values 
          (#{company_idx}, #{survey_title}, #{survey_date}, #{survey_point}, #{survey_time}, #{survey_targetAge},
            #{survey_targetGender}, #{survey_targetJob}, #{survey_info}) 
   </insert>
   
   <select id="selectQuestionList" resultType="surveyQuestion" parameterType="int">
      select * from question where question_idx > 1 order by question_idx
   </select>

   <select id="selectSurveyIdx" resultType="int">
      select * from(select survey_idx from survey order by rownum desc) where rownum = 1
   </select>
   
	
	

</mapper>